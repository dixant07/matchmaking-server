name: Deploy Matchmaking Server to Cloud Run

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Verify authentication to Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker --quiet

      - name: Build and Push Container
        run: |
          export PROJECT_ID=$(gcloud config get-value project)
          export IMAGE="gcr.io/$PROJECT_ID/matchmaking-server:latest"
          
          # Build Docker image
          docker build -t $IMAGE .
          
          # Push to Container Registry
          docker push $IMAGE

      - name: Deploy to Cloud Run
        run: |
          export PROJECT_ID=$(gcloud config get-value project)
          export IMAGE="gcr.io/$PROJECT_ID/matchmaking-server:latest"
          
          # Deploy with necessary flags for WebSocket & Redis support
          # --timeout=3600: Allow 1 hour connection duration
          # --session-affinity: Required for Socket.IO stickiness
          # --vpc-connector: Connect to Redis (Memorystore)
          
          gcloud run deploy matchmaking-server \
            --image $IMAGE \
            --region us-central1 \
            --platform managed \
            --allow-unauthenticated \
            --timeout=3600 \
            --session-affinity \
            --vpc-connector=rumi-connector \
            --set-env-vars="REDIS_URL=${{ secrets.REDIS_URL }},FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }},MATCHMAKING_SERVER_KEY=${{ secrets.MATCHMAKING_SERVER_KEY }},FIREBASE_SERVICE_ACCOUNT_KEY=${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }},GAME_TURN_URL=${{ secrets.GAME_TURN_URL }}, GAME_TURN_SECRET=${{ secrets.GAME_TURN_SECRET }}, MATCHMAKING_SERVER_KEY=${{ secrets.MATCHMAKING_SERVER_KEY }}, PORT=${{ secrets.PORT }}, SOCKET_IO_PATH=${{ secrets.SOCKET_IO_PATH }}, VIDEO_TURN_URL=${{ secrets.VIDEO_TURN_URL }}, VIDEO_TURN_SECRET=${{ secrets.VIDEO_TURN_SECRET }}"
